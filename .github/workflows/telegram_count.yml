name: telegram_count

on:
  schedule:
    - cron: "0 16 * * *"
  workflow_dispatch:
  
jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      actions: write

    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/cache/restore@v4
        id: cache
        with:
          key: telegram_count
          path: last_id

      - run: |
          if [ ! -z "${{ secrets.BOT_TOKEN }}" ]; then
            gh cache delete telegram_count || true
            BOTAPI="https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}"
            id="$(curl "$BOTAPI/sendMessage?chat_id=${{ secrets.CHAT_ID }}&text=消息计数中" | jq .result.message_id)"
            if [ -f last_id ]; then
                last_id="$(cat last_id)"
            elif [ ! -z "${{ secrets.LAST_ID }}" ]; then
                last_id="${{ secrets.LAST_ID }}"
            else
                last_id=$id
            fi
            message_count=$(( id - last_id ))
            curl -o /dev/null "$BOTAPI/editMessageText?chat_id=${{ secrets.CHAT_ID }}&message_id=$id&text=昨日消息数：($message_count)"
            echo -n $id > last_id
          fi

      - uses: actions/cache/save@v4
        with:
          key: telegram_count
          path: last_id
